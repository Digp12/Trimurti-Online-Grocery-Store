<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="ISO-8859-1">
  <title>All Orders</title>
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .card-sh {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
    .table-light {
      background-color: #f8f9fa;
    }
    .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-primary:hover {
      background-color: #0069d9;
      border-color: #0062cc;
    }
    .pagination {
      justify-content: center;
    }
    .con {
      padding-left: 15%;
    }
  </style>
</head>
<body>

  <div th:replace="~{header::layout(~{::section})}"></div>

  <section class="con">
    <div class="container-fluid mt-5 p-4">
      <div class="row">
        <p class="text-center fs-3 mt-2">All Orders</p>
        <hr>
        <a href="/admin/" class="text-decoration-none"><i class="fa-solid fa-arrow-left"></i> Back</a>

        <th:block th:if="${session.succMsg}">
          <p class="text-success fw-bold text-center mt-2">[[${session.succMsg}]]</p>
          <th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
        </th:block>

        <th:block th:if="${session.errorMsg}">
          <p class="text-danger fw-bold text-center mt-2">[[${session.errorMsg}]]</p>
          <th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
        </th:block>

        <div class="col-md-8 p-3">
          <div class="row">
            <div class="col-md-6">
              <form action="/admin/search-order" method="get">
                <div class="row">
                  <div class="col">
                    <input type="text" class="form-control" name="orderId" placeholder="Enter order id">
                  </div>
                  <div class="col">
                    <button class="btn btn-primary col">Search</button>
                  </div>
                </div>
              </form>
            </div>
            <div class="col-md-6">
              <form method="get" action="/admin/orders-by-status">
                <div class="input-group mb-3">
                  <label class="input-group-text" for="statusFilter">Filter by Status</label>
                  <select class="form-select" id="statusFilter" name="status" onchange="this.form.submit()">
                    <option value="ALL" th:selected="${selectedStatus == 'ALL'}">All</option>
                    <option th:each="status : ${statuses}"
                            th:value="${status.name()}"
                            th:text="${status.name}"
                            th:selected="${selectedStatus == status.name()}">
                    </option>
                  </select>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-12 ps-4 pe-4">
          <table class="table table-bordered card-sh">
            <thead class="table-light">
              <tr>
                <th scope="col">Order Id</th>
                <th scope="col">Delivery Details</th>
                <th scope="col">Date</th>
                <th scope="col">Product Details</th>
                <th scope="col">Total Amount</th>
                <th scope="col">Status</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="o : ${orders}">
                <td>[[${o.orderId}]]</td>
                <td>
                  Name: [[${o.orderAddress.firstName + ' ' + o.orderAddress.lastName}]]<br>
                  Email: [[${o.orderAddress.email}]]<br>
                  Mobile: [[${o.orderAddress.mobileNo}]]<br>
                  Address: [[${o.orderAddress.address}]], [[${o.orderAddress.city}]], [[${o.orderAddress.state}]] - [[${o.orderAddress.pincode}]]
                </td>
                <td>[[${o.orderDate}]]</td>
                <td>
                  <table class="table table-sm table-striped">
                    <thead>
                      <tr>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Subtotal</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="po : ${o.productOrders}">
                        <td>[[${po.product.title}]]</td>
                        <td>[[${po.quantity}]]</td>
                        <td>₹[[${po.price}]]</td>
                        <td>₹[[${po.price * po.quantity}]]</td>
                      </tr>
                    </tbody>
                  </table>
                </td>
                <td>₹[[${o.totalAmount}]]</td>
                <td>[[${o.status}]]</td>
                <td>
                  <form action="/admin/update-order-status" method="post" onsubmit="return validateStatus(this)">
                    <div class="row">
                      <div class="col">
                        <select class="form-control" name="st" required>
                          <option value="">--select--</option>
                          <option value="1">In Progress</option>
                          <option value="2">Order Received</option>
                          <option value="3">Product Packed</option>
                          <option value="4">Out for Delivery</option>
                          <option value="5">Delivered</option>
                          <option value="6">Cancelled</option>
                        </select>
                      </div>
                      <input th:value="${o.id}" name="id" type="hidden">
                      <div class="col">
                        <th:block th:if="${o.status=='Cancelled' || o.status=='Delivered'}">
                          <button class="btn btn-primary btn-sm col disabled" disabled>Update</button>
                        </th:block>
                        <th:block th:unless="${o.status=='Cancelled' || o.status=='Delivered'}">
                          <button class="btn btn-sm btn-primary" type="submit">Update</button>
                        </th:block>
                      </div>
                    </div>
                  </form>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="row mt-3 justify-content-between align-items-center">
            <div class="col-md-auto">Total Orders: [[${totalElements}]]</div>
            <div class="col-md-auto">
              <nav aria-label="Page navigation">
                <ul class="pagination">
                  <li class="page-item" th:classappend="${isFirst} ? 'disabled' : ''">
                    <a class="page-link" th:href="@{'/admin/orders?pageNo=' + ${pageNo - 1}}" aria-label="Previous">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                  <li th:each="i : ${#numbers.sequence(1, totalPages)}" class="page-item" th:classappend="${pageNo + 1 == i} ? 'active' : ''">
                    <a class="page-link" th:href="@{'/admin/orders?pageNo=' + ${i - 1}}">[[${i}]]</a>
                  </li>
                  <li class="page-item" th:classappend="${isLast} ? 'disabled' : ''">
                    <a class="page-link" th:href="@{'/admin/orders?pageNo=' + ${pageNo + 1}}" aria-label="Next">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
  <script src="/js/admin-validation.js"></script>

  <script>
    function validateStatus(form) {
      const statusSelect = form.querySelector('select[name="st"]');
      if (!statusSelect.value) {
        alert('Please select an order status');
        statusSelect.focus();
        return false;
      }
      return true;
    }
  </script>

</body>
